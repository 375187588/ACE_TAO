variables:
   ACE_ROOT: $(Build.SourcesDirectory)/ACE
   TAO_ROOT: $(Build.SourcesDirectory)/TAO
   system.prefergit: true

resources:
- repo: self
  fetchDepth: 1

jobs:
- job: VisualStudio2017
  pool:
    vmImage: 'vs2017-win2016'
  steps:
  - powershell: |
      '#include "ace/config-win32.h"' > $(Build.SourcesDirectory)/ACE/ace/config.h
    displayName: 'Create config.h file'
  - powershell: |
      $client = new-object System.Net.WebClient
      $client.DownloadFile("http://strawberryperl.com/download/5.28.0.1/strawberry-perl-5.28.0.1-64bit.zip","strawberry-perl.zip");
    displayName: 'Download perl'
  - task: ExtractFiles@1
    displayName: 'Extract perl'
    inputs:
      archiveFilePatterns: 'strawberry-perl.zip'
      destinationFolder: perl
  - powershell: git clone --depth 1 git://github.com/DOCGroup/MPC.git $(Build.SourcesDirectory)\ACE\MPC
    displayName: 'git clone MPC'
  - powershell: perl/perl/bin/perl ACE/bin/mwc.pl -type vs2017 TAO/TAO_ACE.mwc
    displayName: 'Run script mwc.pl on TAO/TAO_ACE.mwc'
  - powershell: perl/perl/bin/perl ACE/bin/mwc.pl -type vs2017 ACE/tests/tests.mwc
    displayName: 'Run script mwc.pl on ACE/tests/tests.mwc'
  - task: VSBuild@1
    displayName: 'Build solution TAO/TAO_ACE.sln'
    inputs:
      solution: 'TAO/TAO_ACE.sln'
      maximumCpuCount: true
  - task: VSBuild@1
    displayName: 'Build solution ACE/tests/tests.sln'
    inputs:
      solution: 'ACE/tests/tests.sln'
      maximumCpuCount: true

jobs:
- job: VisualStudio2015
  pool:
    vmImage: 'vs2015-win2012r2'
  steps:
  - powershell: |
      '#include "ace/config-win32.h"' > $(Build.SourcesDirectory)/ACE/ace/config.h
    displayName: 'Create config.h file'
  - powershell: |
      $client = new-object System.Net.WebClient
      $client.DownloadFile("http://strawberryperl.com/download/5.28.0.1/strawberry-perl-5.28.0.1-64bit.zip","strawberry-perl.zip");
    displayName: 'Download perl'
  - task: ExtractFiles@1
    displayName: 'Extract perl'
    inputs:
      archiveFilePatterns: 'strawberry-perl.zip'
      destinationFolder: perl
  - powershell: git clone --depth 1 git://github.com/DOCGroup/MPC.git $(Build.SourcesDirectory)\ACE\MPC
    displayName: 'git clone MPC'
  - powershell: perl/perl/bin/perl ACE/bin/mwc.pl -type vc14 TAO/TAO_ACE.mwc
    displayName: 'Run script mwc.pl on TAO/TAO_ACE.mwc'
  - powershell: perl/perl/bin/perl ACE/bin/mwc.pl -type vc14 ACE/tests/tests.mwc
    displayName: 'Run script mwc.pl on ACE/tests/tests.mwc'
  - task: VSBuild@1
    displayName: 'Build solution TAO\TAO_ACE.sln'
    inputs:
      solution: 'TAO\TAO_ACE.sln'
      maximumCpuCount: true
  - task: VSBuild@1
    displayName: 'Build solution ACE\tests\tests.sln'
    inputs:
      solution: 'ACE\tests\tests.sln'
      maximumCpuCount: true

jobs:
- job: Linux
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - powershell: |
      '#include "ace/config-linux.h"' > $(Build.SourcesDirectory)/ACE_TAO/ACE/ace/config.h
    displayName: 'Create config.h file'
  - powershell: |
      'include $(ACE_ROOT)/include/makeinclude/platform_linux.GNU' > $(Build.SourcesDirectory)/ACE_TAO/ACE/include/makeinclude/platform_macros.GNU;
    displayName: 'Create platform_macros file'
  - powershell: git clone --depth 1 git://github.com/DOCGroup/MPC.git $(Build.SourcesDirectory)/ACE/MPC
    displayName: 'git clone MPC'
  - bash: perl ACE_TAO/ACE/bin/mwc.pl -type gnuace TAO/TAO_ACE.mwc
    displayName: 'Run mwc.pl on TAO/TAO_ACE.mwc'
  - bash: perl ACE_TAO/ACE/bin/mwc.pl -type gnuace ACE/tests/tests.mwc
    displayName: 'Run mwc.pl on ACE/tests/tests.mwc'
  - bash: make -j 6 TAO
    displayName: 'Build TAO project'
  - bash: make -j 6 ACE/tests
    displayName: 'Build tests project'








